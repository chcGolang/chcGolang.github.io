<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Nignx知识终结 | Chc</title><meta name="description" content="Nignx知识终结"><meta name="keywords" content="nginx"><meta name="author" content="Chc"><meta name="copyright" content="Chc"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="http://qiniu.caihc.site/hexo/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="https://blog.caihc.site/posts/e9ce0807/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Nignx知识终结"><meta name="twitter:description" content="Nignx知识终结"><meta name="twitter:image" content="http://qiniu.caihc.site/20201026104446.png"><meta property="og:type" content="article"><meta property="og:title" content="Nignx知识终结"><meta property="og:url" content="https://blog.caihc.site/posts/e9ce0807/"><meta property="og:site_name" content="Chc"><meta property="og:description" content="Nignx知识终结"><meta property="og:image" content="http://qiniu.caihc.site/20201026104446.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="next" title="KeepAlived使用教程" href="https://blog.caihc.site/posts/4d9e1630/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://blog.caihc.site/","msgToTraditionalChinese":"简","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nignx知识终结"><span class="toc-number">1.</span> <span class="toc-text">Nignx知识终结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nignx基本配置文件说明"><span class="toc-number">1.1.</span> <span class="toc-text">nignx基本配置文件说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-conf配置结构"><span class="toc-number">1.1.1.</span> <span class="toc-text">nginx.conf配置结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-conf配置说明"><span class="toc-number">1.1.2.</span> <span class="toc-text">nginx.conf配置说明</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx命令"><span class="toc-number">1.2.</span> <span class="toc-text">nginx命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx日志切割"><span class="toc-number">1.3.</span> <span class="toc-text">nginx日志切割</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#location-正则匹配"><span class="toc-number">1.4.</span> <span class="toc-text">location 正则匹配</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-精确匹配"><span class="toc-number">1.4.1.</span> <span class="toc-text">1. = :精确匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-表示uri以某个常规字符串开头"><span class="toc-number">1.4.2.</span> <span class="toc-text">2. ^~: 表示uri以某个常规字符串开头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-区分大小写的正则匹配"><span class="toc-number">1.4.3.</span> <span class="toc-text">3. ~:区分大小写的正则匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-不区分大小写的正则匹配"><span class="toc-number">1.4.4.</span> <span class="toc-text">4. ~*:不区分大小写的正则匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-和-分别为区分大小写不匹配及不区分大小写不匹配-的正则"><span class="toc-number">1.4.5.</span> <span class="toc-text">5. !~ 和!~* 分别为区分大小写不匹配及不区分大小写不匹配 的正则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-通用匹配，任何请求都会匹配到"><span class="toc-number">1.4.6.</span> <span class="toc-text">6. / 通用匹配，任何请求都会匹配到</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-匹配顺序"><span class="toc-number">1.4.7.</span> <span class="toc-text">7. 匹配顺序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-常用规则"><span class="toc-number">1.4.8.</span> <span class="toc-text">8. 常用规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx跨域支持"><span class="toc-number">1.5.</span> <span class="toc-text">nginx跨域支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx防盗链"><span class="toc-number">1.6.</span> <span class="toc-text">nginx防盗链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx负载均衡-upstream"><span class="toc-number">1.7.</span> <span class="toc-text">nginx负载均衡:upstream</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#轮询"><span class="toc-number">1.7.1.</span> <span class="toc-text">轮询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#权重"><span class="toc-number">1.7.2.</span> <span class="toc-text">权重</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip-hash"><span class="toc-number">1.7.3.</span> <span class="toc-text">ip_hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#upstream-参数"><span class="toc-number">1.7.4.</span> <span class="toc-text">upstream 参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Keepalived-提高吞吐量"><span class="toc-number">1.8.</span> <span class="toc-text">使用Keepalived 提高吞吐量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx缓存"><span class="toc-number">1.9.</span> <span class="toc-text">nginx缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#控制浏览器缓存"><span class="toc-number">1.9.1.</span> <span class="toc-text">控制浏览器缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#反向代理缓存"><span class="toc-number">1.9.2.</span> <span class="toc-text">反向代理缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx使用https"><span class="toc-number">1.10.</span> <span class="toc-text">nginx使用https</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx配置websocket"><span class="toc-number">2.</span> <span class="toc-text">nginx配置websocket</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx限流"><span class="toc-number">3.</span> <span class="toc-text">nginx限流</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IP限流"><span class="toc-number">3.1.</span> <span class="toc-text">IP限流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务器级别的限流"><span class="toc-number">3.2.</span> <span class="toc-text">服务器级别的限流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#连接数级别的限流"><span class="toc-number">3.3.</span> <span class="toc-text">连接数级别的限流</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://qiniu.caihc.site/20201026104446.png)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Chc</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="http://qiniu.caihc.site/hexo/hear.jpg" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description"></div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Nignx知识终结</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-10-26<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-10-26</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/linux/">linux</a></span></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="Nignx知识终结"><a href="#Nignx知识终结" class="headerlink" title="Nignx知识终结"></a>Nignx知识终结</h1><p>[TOC]</p>
<h2 id="nignx基本配置文件说明"><a href="#nignx基本配置文件说明" class="headerlink" title="nignx基本配置文件说明"></a>nignx基本配置文件说明</h2><h3 id="nginx-conf配置结构"><a href="#nginx-conf配置结构" class="headerlink" title="nginx.conf配置结构"></a>nginx.conf配置结构</h3><ul>
<li><code>main</code> 全局配置</li>
<li><code>event</code> 配置工作模式和连接数</li>
<li><code>http</code> http模块相关配置<ul>
<li><code>server</code>虚拟主机配置,可以配置多个</li>
<li><code>location</code> 路由规则,表达式</li>
<li><code>upstream</code> 集群,内网服务器</li>
</ul>
</li>
</ul>
<h3 id="nginx-conf配置说明"><a href="#nginx-conf配置说明" class="headerlink" title="nginx.conf配置说明"></a>nginx.conf配置说明</h3><p><code>nginx.conf</code>默认所在位置<code>/usr/local/nginx/conf/</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> user 指定运行 nginx 的用户和组（第一个参数为用户第二个为组，这里只有用户）</span></span><br><span class="line"><span class="meta">#</span><span class="bash">user  nobody;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定工作进程数（一般设置为CPU核数）</span></span><br><span class="line">worker_processes  1;   </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定错误日志为 logs/ 目录下的 error.log 文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志格式有:debug,info,notice,warn,error,crit</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定错误日志，并指定写入格式为 notice</span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定错误日志，并指定写入格式为 info  </span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定 pid 文件（存放主进程 pid 号）</span></span><br><span class="line"><span class="meta">#</span><span class="bash">pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> nginx 连接配置模块</span></span><br><span class="line">events &#123;</span><br><span class="line">    # 默认使用epoll</span><br><span class="line">    use epoll</span><br><span class="line">    # 指定每个worker工作进程最大连接数为 1024</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> http 配置模块</span></span><br><span class="line">http &#123;</span><br><span class="line">    # 通过 include 加载 mime.types 文件，里面的 types &#123;&#125; 模块将文件扩展名映射到响应的 MIME 类型</span><br><span class="line">    include       mime.types;</span><br><span class="line">    # 定义响应的默认 MIME 类型</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # 写入格式 main 的内容格式如下</span><br><span class="line">    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">    #                  '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">    #                  '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    # 指定访问日志和写入格式为 main</span><br><span class="line">    #access_log  logs/access.log  main;</span><br><span class="line"></span><br><span class="line">    # 启用或者禁用 sendfile()</span><br><span class="line">    sendfile        on;</span><br><span class="line">    # 启用或者禁用使用套接字选项（仅在 sendfile 使用时使用）</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    # 0 值禁用保持活动的客户端连接</span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    # 65 s 超时</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    # 启用或者禁用 gzip</span><br><span class="line">    gzip  on;</span><br><span class="line">     # 启用gzip压缩的最小文件，小于设置值的文件将不会压缩</span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line">    # gzip 压缩级别，1-9，数字越大压缩的越好，也越占用CPU时间,推荐1</span><br><span class="line">    gzip_comp_level 1;</span><br><span class="line">    # 进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。</span><br><span class="line">    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/vnd.ms-fontobject font/ttf font/opentype font/x-woff image/svg+xml application/json application/xml+rss;</span><br><span class="line">    # 是否在http header中添加Vary: Accept-Encoding，建议开启</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    # 禁用IE 6 gzip</span><br><span class="line">    gzip_disable "MSIE [1-6]\.";</span><br><span class="line">    # 设置压缩所需要的缓冲区大小     </span><br><span class="line">    gzip_buffers 32 4k;</span><br><span class="line">    # 设置gzip压缩针对的HTTP协议版本</span><br><span class="line">    gzip_http_version 1.1;</span><br><span class="line"></span><br><span class="line">    # 虚拟主机配置模块</span><br><span class="line">    server &#123;</span><br><span class="line">        # 监听 80 端口</span><br><span class="line">        listen       80;</span><br><span class="line">        # 监听域名为 localhost</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        # 将指定的 charset 添加到 “Content-Type” 响应头字段。如果此charset与source_charset指令中指定的charset不同，则执行转换。</span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        # 指定该虚拟主机的访问日志</span><br><span class="line">        #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">        # 将特定的文件或目录重新定位，如 php 文件，image 目录等</span><br><span class="line">        location / &#123;</span><br><span class="line">            # 设置请求的根目录</span><br><span class="line">            root   html;</span><br><span class="line">            # 定义索引，按顺序匹配</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # 定义显示 404 错误的 uri</span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">        # redirect server error pages to the static page /50x.html</span><br><span class="line">        #</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        # location 精准匹配 '/50x.html'</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        location  /image &#123;</span><br><span class="line">            alias /home;</span><br><span class="line">        &#125;</span><br><span class="line">        # 使用别名的方式加载,于上面的/image效果一致,作用避免暴露服务器文件目录结构</span><br><span class="line">        location  /static &#123;</span><br><span class="line">            alias /home/image;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">        # 正则表达式匹配 php 文件</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">            # 设置代理服务器的协议和地址，以及应该映射位置的可选URI。作为协议，可以指定“http”或“https”。该地址可以指定为一个域名或IP地址，以及一个可选端口</span><br><span class="line">        #    proxy_pass   http://127.0.0.1;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    root           html;</span><br><span class="line">             # 设置 FastCGI 服务器的地址。地址可以指定为一个域名或 IP 地址，以及一个端口</span><br><span class="line">        #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">             # 设置将在以斜杠结尾的URI之后追加的文件名，</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">             # 设置一个应该传递给FastCGI服务器的参数。</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">             # 加载 conf/fastcgi_params 文件</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        # deny access to .htaccess files, if Apache's document root</span><br><span class="line">        # concurs with nginx's one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht &#123;</span><br><span class="line">        #    deny  all;</span><br><span class="line">        #&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # another virtual host using mix of IP-, name-, and port-based configuration</span><br><span class="line">    #</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       8000;</span><br><span class="line">    #    listen       somename:8080;</span><br><span class="line">    #    server_name  somename  alias  another.alias;</span><br><span class="line"></span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    # HTTPS server</span><br><span class="line">    #</span><br><span class="line">    # ssl 配置，要启用 ssl 模块需要在编译 nginx 时加上 --with-http_ssl_module 参数</span><br><span class="line">    #server &#123;</span><br><span class="line">    #    listen       443 ssl;</span><br><span class="line">    #    server_name  localhost;</span><br><span class="line"></span><br><span class="line">    #    ssl_certificate      cert.pem;</span><br><span class="line">    #    ssl_certificate_key  cert.key;</span><br><span class="line"></span><br><span class="line">    #    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    #    ssl_session_timeout  5m;</span><br><span class="line"></span><br><span class="line">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    #    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    #    location / &#123;</span><br><span class="line">    #        root   html;</span><br><span class="line">    #        index  index.html index.htm;</span><br><span class="line">    #    &#125;</span><br><span class="line">    #&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="nginx命令"><a href="#nginx命令" class="headerlink" title="nginx命令"></a>nginx命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>nginx -s stop</code></td>
<td>停止nginx</td>
</tr>
<tr>
<td><code>nginx -s reload</code></td>
<td>重新加载配置</td>
</tr>
<tr>
<td><code>nginx -t</code></td>
<td>检测配置文件是否正确</td>
</tr>
<tr>
<td><code>nginx -V</code></td>
<td>查看nginx版本号和启动信息</td>
</tr>
</tbody></table>
<h2 id="nginx日志切割"><a href="#nginx日志切割" class="headerlink" title="nginx日志切割"></a>nginx日志切割</h2><ul>
<li><p>切割脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">LOG_PATH=<span class="string">"/var/log/nginx/"</span></span><br><span class="line">RECORD_TIME=$(date -d <span class="string">"yesterday"</span> +%Y-%m-%d+%H:%M)</span><br><span class="line">PID=/var/run/nginx.pid</span><br><span class="line">mv <span class="variable">$&#123;LOG_PATH&#125;</span>/access.log <span class="variable">$&#123;LOG_PATH&#125;</span>/access.<span class="variable">$&#123;RECORD_TIME&#125;</span>.<span class="built_in">log</span></span><br><span class="line">mv <span class="variable">$&#123;LOG_PATH&#125;</span>/error.log <span class="variable">$&#123;LOG_PATH&#125;</span>/error.<span class="variable">$&#123;RECORD_TIME&#125;</span>.<span class="built_in">log</span></span><br><span class="line"><span class="comment">#向Nginx主进程发送信号，用于重新打开日志文件</span></span><br><span class="line"><span class="built_in">kill</span> -USR1 `cat <span class="variable">$PID</span>`</span><br></pre></td></tr></table></figure>

<p>pid文件可以使用<code>nginx -V</code>或者在<code>nginx.conf</code>中查看</p>
</li>
</ul>
<h2 id="location-正则匹配"><a href="#location-正则匹配" class="headerlink" title="location 正则匹配"></a>location 正则匹配</h2><blockquote>
<p>语法规则： location [ = | ~ | ~ * | ^~ ] /uri/ { … }</p>
</blockquote>
<h3 id="1-精确匹配"><a href="#1-精确匹配" class="headerlink" title="1. = :精确匹配"></a>1. <code>=</code> :精确匹配</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 精确匹配，必须是127.0.0.1/</span></span><br><span class="line">location = / &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash">规则A</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 精确匹配，必须是127.0.0.1/login</span></span><br><span class="line">location = /login &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash">规则B</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-表示uri以某个常规字符串开头"><a href="#2-表示uri以某个常规字符串开头" class="headerlink" title="2. ^~: 表示uri以某个常规字符串开头"></a>2. <code>^~</code>: 表示uri以某个常规字符串开头</h3><p>可以理解为匹配 url路径即可</p>
<p>nginx不对url做编码，因此请求为<code>/static/20%/aa</code>，可以被规则<code>^~ /static/ /aa</code>匹配到<code>（注意是空格）</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 非精确匹配，并且不区分大小写，比如127.0.0.1/static/js.</span></span></span><br><span class="line">location ^~ /static/ &#123;</span><br><span class="line">    #规则C</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-区分大小写的正则匹配"><a href="#3-区分大小写的正则匹配" class="headerlink" title="3. ~:区分大小写的正则匹配"></a>3. <code>~</code>:区分大小写的正则匹配</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 区分大小写，以gif,jpg,js结尾</span></span></span><br><span class="line">location ~ \.(gif|jpg|png|js|css)$ &#123;</span><br><span class="line">    #规则D</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-不区分大小写的正则匹配"><a href="#4-不区分大小写的正则匹配" class="headerlink" title="4. ~*:不区分大小写的正则匹配"></a>4. <code>~*</code>:不区分大小写的正则匹配</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 不区分大小写，匹配.png和.PNG结尾的</span></span></span><br><span class="line">location ~* \.png$ &#123;</span><br><span class="line">    #规则E</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-和-分别为区分大小写不匹配及不区分大小写不匹配-的正则"><a href="#5-和-分别为区分大小写不匹配及不区分大小写不匹配-的正则" class="headerlink" title="5. !~ 和!~* 分别为区分大小写不匹配及不区分大小写不匹配 的正则"></a>5. <code>!~</code> 和<code>!~*</code> 分别为<code>区分大小写不匹配</code>及<code>不区分大小写不匹配</code> 的正则</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 区分大小写，匹配不以.xhtml结尾的</span></span></span><br><span class="line">location !~ \.xhtml$ &#123;</span><br><span class="line">    #规则F</span><br><span class="line">&#125;</span><br><span class="line">location !~* \.xhtml$ &#123;</span><br><span class="line">    #规则G</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-通用匹配，任何请求都会匹配到"><a href="#6-通用匹配，任何请求都会匹配到" class="headerlink" title="6. / 通用匹配，任何请求都会匹配到"></a>6. <code>/</code> 通用匹配，任何请求都会匹配到</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 什么都可以</span></span></span><br><span class="line">location / &#123;</span><br><span class="line">    #规则H</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-匹配顺序"><a href="#7-匹配顺序" class="headerlink" title="7. 匹配顺序"></a>7. 匹配顺序</h3><blockquote>
<p>多个location配置的情况下匹配顺序为：<br>首先匹配<code>=</code> ；<br>其次匹配<code>^~</code>；
再其次是按文件中顺序的正则匹配；<br>最后是交给 / 通用匹配；<br>当有匹配成功时候，停止匹配，按当前匹配规则处理请求。</p>
</blockquote>
<p>匹配效果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">访问根目录/， 比如http://localhost/    //将匹配规则A</span><br><span class="line"></span><br><span class="line">访问 http://localhost/login 将匹配规则B</span><br><span class="line"></span><br><span class="line">访问 http://localhost/register 则匹配规则H</span><br><span class="line"></span><br><span class="line">访问 http://localhost/static/a.html 将匹配规则C</span><br><span class="line"></span><br><span class="line">访问 http://localhost/a.gif, http://localhost/b.jpg 将匹配规则D和规则E，但是规则D顺序优先，规则E不起作用， 而 http://localhost/static/c.png 则优先匹配到 规则C</span><br><span class="line"></span><br><span class="line">访问 http://localhost/a.PNG 则匹配规则E， 而不会匹配规则D，因为规则E不区分大小写。</span><br><span class="line"></span><br><span class="line">访问 http://localhost/a.xhtml 不会匹配规则F和规则G，http://localhost/a.XHTML不会匹配规则G，因为不区分大小写。规则F，规则G属于排除法，符合匹配规则但是不会匹配到，所以想想看实际应用中哪里会用到。</span><br><span class="line"></span><br><span class="line">访问 http://localhost/category/id/1111 则最终匹配到规则H，因为以上规则都不匹配，这个时候应该是nginx转发请求给后端应用服务器，比如FastCGI（php），tomcat（jsp），nginx作为方向代理服务器存在。</span><br></pre></td></tr></table></figure>

<h3 id="8-常用规则"><a href="#8-常用规则" class="headerlink" title="8. 常用规则"></a>8. 常用规则</h3><ul>
<li><p>第一个规则</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location = / &#123;</span><br><span class="line">  proxy_pass http://127.0.0.1:3000/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二规则</p>
<blockquote>
<p>第二个规则是处理静态文件请求，这是nginx作为http服务器的强项<br>有两种配置模式，<code>目录匹配</code>和<code>后缀匹配</code>,任选其一或搭配使用</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /static/ &#123;</span><br><span class="line">  root /webroot/static/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ &#123;</span><br><span class="line">  root /webroot/res/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三规则</p>
<p>用来转发动态请求到后端应用服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  location /api/ &#123;</span><br><span class="line">      proxy_pass http://127.0.0.1:3000/api/</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="nginx跨域支持"><a href="#nginx跨域支持" class="headerlink" title="nginx跨域支持"></a>nginx跨域支持</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    #允许跨域请求的域，*代表所有</span><br><span class="line">    add_header 'Access-Control-Allow-Origin' *;</span><br><span class="line">    #允许带上cookie请求</span><br><span class="line">    add_header 'Access-Control-Allow-Credentials' 'true';</span><br><span class="line">    #允许请求的方法，比如 GET/POST/PUT/DELETE</span><br><span class="line">    add_header 'Access-Control-Allow-Methods' *;</span><br><span class="line">    #允许请求的header</span><br><span class="line">    add_header 'Access-Control-Allow-Headers' *;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="nginx防盗链"><a href="#nginx防盗链" class="headerlink" title="nginx防盗链"></a>nginx防盗链</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">location ~* \.(gif|jpg|swf)$ &#123; </span><br><span class="line"><span class="meta">  #</span><span class="bash"> 防盗链,指定*.caihc.site *.caihc.com这两个域名才可以访问</span></span><br><span class="line">  valid_referers *.caihc.site *.caihc.com; </span><br><span class="line">  if ($invalid_referer) &#123; </span><br><span class="line">    # 重定向到logn文件</span><br><span class="line">    # rewrite ^/ http://$host/logo.png;</span><br><span class="line">    </span><br><span class="line">    # 返回404状态</span><br><span class="line">    return 404;</span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：<br>如果 <code>valid_referers</code> 条件判断未通过，nginx 则会赋值 <code>invalid_referer</code> 为<code>true</code><br>语法: <code>valid_referers none | blocked | server_names | string ...;</code></p>
<p>参数说明:<br><code>none</code>:  不允许 “Referer” 来源头部为空的情况<br><code>blocked</code>: 不允许“Referer”值为空情况，有可能Referer的值被代理或者防火墙删除<br><code>server_names</code>: “Referer”来源头部包必须含当前的server_names （当前域名）可以多个</p>
</blockquote>
<h2 id="nginx负载均衡-upstream"><a href="#nginx负载均衡-upstream" class="headerlink" title="nginx负载均衡:upstream"></a>nginx负载均衡:<code>upstream</code></h2><blockquote>
<p>官方文档地址:<a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank" rel="noopener">http://nginx.org/en/docs/http/ngx_http_upstream_module.html</a></p>
</blockquote>
<h3 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080;</span><br><span class="line">    server 192.168.1.174:8080;</span><br><span class="line">    server 192.168.1.175:8080;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  tomcats.caihc.site;</span><br><span class="line">     location / &#123;</span><br><span class="line">     	# 指定使用的upstream</span><br><span class="line">     	proxy_pass http://tomcats;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080 weight=1;</span><br><span class="line">    server 192.168.1.174:8080 weight=2;</span><br><span class="line">    server 192.168.1.175:8080 weight=3;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  tomcats.caihc.site;</span><br><span class="line">     location / &#123;</span><br><span class="line">     	# 指定使用的upstream</span><br><span class="line">     	proxy_pass        http://tomcats;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>weight权重越高处理的请求就越多</p>
</blockquote>
<h3 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h3><p><code>ip_hash</code> 可以保证用户访问可以请求到上游服务中的固定的服务器，前提是用户ip没有发生更改。<br>使用ip_hash的注意点：<br>不能把后台服务器直接移除，只能标记 down .</p>
<blockquote>
<p>If one of the servers needs to be temporarily removed, it should be marked with the <code>down</code> parameter in order to preserve the current hashing of client IP addresses.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 192.168.1.173:8080;</span><br><span class="line">    server 192.168.1.174:8080 down;</span><br><span class="line">    server 192.168.1.175:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="upstream-参数"><a href="#upstream-参数" class="headerlink" title="upstream 参数"></a>upstream 参数</h3><ul>
<li><p><strong>max_conns</strong></p>
<p>限制每台server的连接数，用于保护避免过载，可起到限流作用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080 max_conns=2;</span><br><span class="line">    server 192.168.1.174:8080 max_conns=2;</span><br><span class="line">    server 192.168.1.175:8080 max_conns=2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>slow_start</strong></p>
<p><strong>商业版需要付费</strong>,在指定时间内缓慢加入集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080 weight=6 slow_start=60s;</span><br><span class="line">    server 192.168.1.174:8080 weight=2;</span><br><span class="line">    server 192.168.1.175:8080 weight=2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong></p>
<ol>
<li>该参数不能使用在 hash 和 random load balancing 中。</li>
<li>如果在 upstream 中只有一台 server，则该参数失效。</li>
</ol>
</li>
<li><p><strong>down、backup</strong></p>
<p><code>down</code>用于标记服务节点不可用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080 down;</span><br><span class="line">    server 192.168.1.174:8080 weight=1;</span><br><span class="line">    server 192.168.1.175:8080 weight=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>backup</code>表示当前服务器节点是备用机，只有在其他的服务器都宕机以后，自己才会加入到集群中，被用户访问到：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080 backup;</span><br><span class="line">    server 192.168.1.174:8080 weight=1;</span><br><span class="line">    server 192.168.1.175:8080 weight=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong></p>
<ol>
<li>backup 参数不能使用在 hash 和 random load balancing 中。</li>
</ol>
</li>
<li><p><strong>max_fails、fail_timeout</strong></p>
<p><code>max_fails</code> ：表示失败几次，则标记server已宕机，剔出上游服务。<br><code>fail_timeout</code> ：表示失败的重试时间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080 backup;</span><br><span class="line">    server 192.168.1.174:8080 weight=1;</span><br><span class="line">    server 192.168.1.175:8080 weight=1 max_fails=2 fail_timeout=15s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>则代表在15秒内请求某一server失败达到2次后，则认为该server已经挂了或者宕机了，随后再过15秒，这15秒内不会有新的请求到达刚刚挂掉的节点上，而是会<br>运作的server，15秒后会再有新请求尝试连接挂掉的server，如果还是失败，重复上一过程，直到恢复。</p>
</blockquote>
</li>
</ul>
<h2 id="使用Keepalived-提高吞吐量"><a href="#使用Keepalived-提高吞吐量" class="headerlink" title="使用Keepalived 提高吞吐量"></a>使用Keepalived 提高吞吐量</h2><p><code>keepalived</code> ： 设置长连接处理的数量<br><code>proxy_http_version</code> ：设置长连接http版本为1.1<br><code>proxy_set_header</code> ：清除connection header 信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080 max_fails=2 fail_timeout=1s;</span><br><span class="line">    server 192.168.1.190:8080;</span><br><span class="line">    keepalive 32;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.tomcats.com;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://tomcats;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection "";</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="nginx缓存"><a href="#nginx缓存" class="headerlink" title="nginx缓存"></a>nginx缓存</h2><h3 id="控制浏览器缓存"><a href="#控制浏览器缓存" class="headerlink" title="控制浏览器缓存"></a>控制浏览器缓存</h3><ul>
<li><p>浏览器缓存和nginx缓存的区别</p>
<ol>
<li>浏览器缓存：<br>加速用户访问，提升单个用户（浏览器访问者）体验，缓存在本地</li>
<li>Nginx缓存<br>缓存在nginx端，提升所有访问到nginx这一端的用户<br>提升访问上游（upstream）服务器的速度<br>用户访问仍然会产生请求流量</li>
</ol>
</li>
<li><p>使用<code>expires</code>控制缓存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /static &#123; # 用于静态文件缓存控制</span><br><span class="line">    alias /home/caihc;</span><br><span class="line">    # expires 10s;     # 缓存过期时间为10秒</span><br><span class="line">    # expires @22h30m; # 22点30分,缓存过期</span><br><span class="line">    # expires -1h;     # 缓存在1个小时前过期</span><br><span class="line">    # expires epoch;   # 不使用缓存(关闭nginx和浏览器端的缓存)</span><br><span class="line">    # expires off;     # 关闭nginx端的缓存</span><br><span class="line">    expires max;       # 缓存永不过期</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="反向代理缓存"><a href="#反向代理缓存" class="headerlink" title="反向代理缓存"></a>反向代理缓存</h3><p>用于缓存服务端文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080;</span><br><span class="line">    server 192.168.1.174:8080;</span><br><span class="line">    server 192.168.1.175:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> proxy_cache_path 设置缓存目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> keys_zone 设置共享内存以及占用空间大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> max_size 设置缓存大小</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> inactive 超过此时间则被清理</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use_temp_path 临时目录，使用后会影响nginx性能,建议关闭(off)</span></span><br><span class="line">proxy_cache_path /usr/local/nginx/upstream_cache keys_zone=mycache:5m max_size=1g inactive=1m use_temp_path=off;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  tomcats.caihc.site;</span><br><span class="line">     </span><br><span class="line">     # 启用缓存，和keys_zone一致</span><br><span class="line">     proxy_cache mycache;</span><br><span class="line">     # 针对200和304状态码缓存时间为8小时</span><br><span class="line">     proxy_cache_valid 200 304 8h;</span><br><span class="line">     </span><br><span class="line">     location / &#123;</span><br><span class="line">     	# 指定使用的upstream</span><br><span class="line">     	proxy_pass        http://tomcats;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="nginx使用https"><a href="#nginx使用https" class="headerlink" title="nginx使用https"></a>nginx使用https</h2><blockquote>
<p>注意:  ssl 配置，要启用 ssl 模块需要在编译 nginx 时加上 –with-http_ssl_module 参数</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.1.173:8080;</span><br><span class="line">    server 192.168.1.174:8080;</span><br><span class="line">    server 192.168.1.175:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">     listen       80;</span><br><span class="line">     server_name  tomcats.caihc.site;</span><br><span class="line">     # 开启ssl</span><br><span class="line">     ssl on;</span><br><span class="line">     # 配置ssl证书</span><br><span class="line">     ssl_certificate 1_tomcats.caihc.site.crt;</span><br><span class="line">     # 配置证书秘钥</span><br><span class="line">     ssl_certificate_key 2_tomcats.caihc.site.key;</span><br><span class="line">     # ssl会话cache</span><br><span class="line">     ssl_session_cache shared:SSL:1m;</span><br><span class="line">     # ssl会话超时时间</span><br><span class="line">     ssl_session_timeout 5m;</span><br><span class="line">     # 配置加密套件，写法遵循 openssl 标准</span><br><span class="line">     ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">     ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;</span><br><span class="line">     ssl_prefer_server_ciphers on;</span><br><span class="line">     </span><br><span class="line">     location / &#123;</span><br><span class="line">     	# 指定使用的upstream</span><br><span class="line">     	proxy_pass       http://tomcats;</span><br><span class="line">     	# 解决https的request.getScheme() return http but not https.</span><br><span class="line">        proxy_redirect http:// $scheme://;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="nginx配置websocket"><a href="#nginx配置websocket" class="headerlink" title="nginx配置websocket"></a>nginx配置websocket</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    <span class="comment"># websocket配置</span></span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="string">'Upgrade'</span>;</span><br><span class="line">    proxy_connect_timeout 60s; <span class="comment"># 发起握手等候响应超时时间</span></span><br><span class="line">    proxy_read_timeout 60s;   <span class="comment"># 连接成功后_等候后端服务器响应时间</span></span><br><span class="line">    proxy_send_timeout 60s;   <span class="comment"># 后端服务器数据回传时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="nginx限流"><a href="#nginx限流" class="headerlink" title="nginx限流"></a>nginx限流</h1><h2 id="IP限流"><a href="#IP限流" class="headerlink" title="IP限流"></a>IP限流</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 根据IP地址限制速度</span></span><br><span class="line">    # 1） 第一个参数 $binary_remote_addr</span><br><span class="line">    #    binary_目的是缩写内存占用，remote_addr表示通过IP地址来限流</span><br><span class="line">    # 2） 第二个参数 zone=iplimit:20m</span><br><span class="line">    #    iplimit(自定义参数)是一块内存区域（记录访问频率信息），20m是指这块内存区域的大小</span><br><span class="line">    # 3） 第三个参数 rate=1r/s 每秒一次请求</span><br><span class="line">    #    比如100r/m，标识访问的限流频率</span><br><span class="line">    limit_req_zone $binary_remote_addr zone=iplimit:20m rate=1r/s;</span><br><span class="line">    server &#123;</span><br><span class="line">        server_name chc.com;</span><br><span class="line">        location /ip-limit/ &#123;</span><br><span class="line">        	# 基于IP地址的限制</span><br><span class="line">            # 1） 第一个参数zone=iplimit =&gt; 引用limit_req_zone中的zone变量</span><br><span class="line">            # 2） 第二个参数burst=2，缓冲队列的长度。</span><br><span class="line">            #     请求数量超过限流频率时，将其放入缓冲区域</span><br><span class="line">            # 3) 第三个参数nodelay=&gt; 缓冲区满了以后，直接返回503异常</span><br><span class="line">            limit_req zone=iplimit burst=2 nodelay;</span><br><span class="line">            </span><br><span class="line">            # 异常情况，返回504（默认是503）</span><br><span class="line">            limit_req_status 504;</span><br><span class="line">            limit_conn_status 504;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="服务器级别的限流"><a href="#服务器级别的限流" class="headerlink" title="服务器级别的限流"></a>服务器级别的限流</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 根据服务器限制速度</span></span><br><span class="line">    # 1） 第一个参数 $server_name</span><br><span class="line">    #    server_name 服务器访问名称</span><br><span class="line">    # 2） 第二个参数 zone=serverlimit:20m</span><br><span class="line">    #    serverlimit(自定义参数)是一块内存区域（记录访问频率信息），20m是指这块内存区域的大小</span><br><span class="line">    # 3） 第三个参数 rate=100r/s 每秒100次请求</span><br><span class="line">    #    比如100r/m，标识访问的限流频率</span><br><span class="line">    limit_req_zone $server_name zone=serverlimit:10m rate=100r/s;</span><br><span class="line">    server &#123;</span><br><span class="line">        server_name chc.com;</span><br><span class="line">        location /server-limit/ &#123;</span><br><span class="line">        	# 基于服务器级别的限制</span><br><span class="line">            # 通常情况下，server级别的限流速率是最大的</span><br><span class="line">            # burst=2，缓冲队列的长度</span><br><span class="line">            # nodelay=&gt; 缓冲区满了以后，直接返回503异常</span><br><span class="line">            limit_req zone=serverlimit burst=100 nodelay;</span><br><span class="line">            </span><br><span class="line">             # 异常情况，返回504（默认是503）</span><br><span class="line">            limit_req_status 504;</span><br><span class="line">            limit_conn_status 504;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="连接数级别的限流"><a href="#连接数级别的限流" class="headerlink" title="连接数级别的限流"></a>连接数级别的限流</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 基于Ip连接数的配置</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> perip(自定义参数)是一块内存区域（记录访问频率信息），20m是指这块内存区域的大小</span></span><br><span class="line">	limit_conn_zone $binary_remote_addr zone=perip:20m;</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 基于服务器连接数的配置</span></span><br><span class="line"><span class="meta">	#</span><span class="bash"> perserver(自定义参数)是一块内存区域（记录访问频率信息），20m是指这块内存区域的大小</span></span><br><span class="line">	limit_conn_zone $server_name zone=perserver:20m;</span><br><span class="line">    server &#123;</span><br><span class="line">        server_name chc.com;</span><br><span class="line">        location /conn-limit/ &#123;</span><br><span class="line">        	# 每个server最多保持100个连接</span><br><span class="line">            limit_conn perserver 100;</span><br><span class="line">            # 每个IP地址最多保持5个连接</span><br><span class="line">            limit_conn perip 5;</span><br><span class="line">            </span><br><span class="line">             # 异常情况，返回504（默认是503）</span><br><span class="line">            limit_req_status 504;</span><br><span class="line">            limit_conn_status 504;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Chc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.caihc.site/posts/e9ce0807/">https://blog.caihc.site/posts/e9ce0807/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.caihc.site">Chc</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/nginx/">nginx    </a></div><div class="post_share"></div></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/posts/4d9e1630/"><img class="next_cover lozad" data-src="http://qiniu.caihc.site/1500x500.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>KeepAlived使用教程</span></div></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2020 By Chc</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">简</a><i class="fa fa-moon-o nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/baidupush.js"></script><script async src="/js/search/local-search.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/js/piao.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>